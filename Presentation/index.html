<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

        <title>Spatial Data Part I</title>

        <link rel="stylesheet" href="css/reveal.css">
        <link rel="stylesheet" href="css/theme/black.css">
        <script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script>
        <!-- Theme used for syntax highlighting of code -->
        <link rel="stylesheet" href="lib/css/zenburn.css">

        <!-- Printing and PDF exports -->
        <script>
            var link = document.createElement( 'link' );
            link.rel = 'stylesheet';
            link.type = 'text/css';
            link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
            document.getElementsByTagName( 'head' )[0].appendChild( link );
        </script>
    </head>
    <body>
        <div class="reveal">
            <div class="slides">
                <section data-markdown>
                    <textarea data-template>
                    ### D3: Geographic Visualizations!
                    Saad Usmani, Kevin Hunt, Noah Johnson
                    </textarea>
                </section>
                <section data-markdown>
                    <textarea data-template>
                    <h3> FOCUS </h3>
                    Using D3 to visualize geographic data. 
                    </textarea>
                </section>
                <section>
                    <h2> OVERVIEW </h2>
                    <ul>
                        <li> Part 1: Understanding TOPOJson and the art of map-making </li>
                        <li> Part 2: Putting the data in and doing funky stuff to it to make it look cool</li>
                    </ul>
                </section>
                <section>
                    <section data-background="green">
                    <h2>PART 1: Understanding TOPOJson and the art of map-making</h2>
                    </section>
                    <section data-background="green">
                        A single TopoJSON file can contain multiple feature collections without duplication, such as states and counties.
                    </section>
                    <section data-background="green">
                        <img src="example.png">
                    </section>
                </section>
                <section>
                	The core components used to create a map of the US:
                	<ul>
                		<li> The projection used </li>
                		<li> The SVG element </li>
                		<li> Map boundaries </li>
                	</ul>
                </section>
                <section>
                    <section data-background="red">
                    <h2>MAP PROJECTIONS</h2>
                    </section>
                    <section data-background="red">
                        There are several different projections you can use to create maps. Here's a few from the TOPOJson package. 
                    </section>
                    <section data-background="red">
                    	<h3>Mercator Projection</h3>
                        <img src="mercator.png">
                    </section >
                    <section data-background="red">
                    	<h3> Gnomonic Projection </h3>
                        <img src="gnomoic.png">
                    </section>
                    <section data-background="red">
                    	<h3> Albers USA Projection </h3>
                        <img src="albers.png">
                    </section>
                    <section data-background="red">
                    	<h3> Settting the projection </h3>
	                    <pre><code class="hljs" data-trim contenteditable>
// Map dimensions
var w = 1280,
h = 800;

var projection = d3.geo.albers()
	.scale(900) // zoom on the map
	.translate([w / 2 - 200, h / 2 - 100]); // sets location of the map on the screen
	                    </code></pre>
                	</section>
                	<section data-background="red">
                		<h3> Place the projection on the screen </h3>
                		<pre><code class="hljs" data-trim contenteditable>
var path = d3.geo.path()
     // takes the [longitude,latitude] pairs and converts to pixel position [x,y] on screen
     .projection(projection);
     					</code></pre>
                	</section>
                	<section data-background="red">
                		<h3> Create the SVG Element </h3>
                		<pre><code class="hljs" data-trim contenteditable>
var svg = d3.select("body").append("svg")
    .attr("width", w)
    .attr("height", h);
     					</code></pre>
                	</section>
                	<section data-background = 'red'>
                		<h3> Drawing the actual map </h3>
                        <h4> The "path" element is the most powerful element in the SVG library of basic shapes. You can use it to create lines, curves, arcs and more.</h4>
                		<pre><code class="hljs" data-trim contenteditable>
d3.json("../us.json", function(error, us) {
    if (error) throw error; // seems to be a convention in d3 examples to include this, does nothing
	    // insert all land masses and classify as land for css styling
	    svg.insert("path")
            .
            .
            .
     					</code></pre>
                    </section>
                    <section data-background = 'red'>
                        <h3> Drawing the actual map </h3>
                        <h4> Load the land data (not yet drawn) and set the class for styling.</h4>
                		<pre><code class="hljs" data-trim contenteditable>
d3.json("../us.json", function(error, us) {
    if (error) throw error; // seems to be a convention in d3 examples to include this, does nothing
	    // insert all land masses and classify as land for css styling
	    svg.insert("path")
	        .datum(topojson.feature(us, us.objects.land))
	        .attr("class", "land")
            .
            .
            .
     					</code></pre>
                    </section>
                    <section data-background = 'red'>
                        <h3> Drawing the actual map </h3>
                        <h4> The "d" attribute of a path contains the instructions for drawing. Here, we use our geographic shape generator (named path) to convert the 
                            loaded data into drawing instructions.
                        </h4>
                		<pre><code class="hljs" data-trim contenteditable>
d3.json("../us.json", function(error, us) {
    if (error) throw error; // seems to be a convention in d3 examples to include this, does nothing
	    // insert all land masses and classify as land for css styling
	    svg.insert("path")
	        .datum(topojson.feature(us, us.objects.land))
	        .attr("class", "land")
	        .attr("d", path);
     					</code></pre>
                    </section>
                    <section data-background="red">
                            <h3> Drawing us.objects.land </h3>
                            <img src="./land.PNG">
                    </section>
                    <section data-background = 'red'>
                            <h3> Drawing the actual map </h3>
                            <h4> Add the state boundaries.</h4>
                		<pre><code class="hljs" data-trim contenteditable>
d3.json("../us.json", function(error, us) {
    if (error) throw error; // seems to be a convention in d3 examples to include this, does nothing
	    // insert all land masses and classify as land for css styling
	    svg.insert("path")
	        .datum(topojson.feature(us, us.objects.land))
	        .attr("class", "land")
	        .attr("d", path);
	    
	    // drawing the state boundaries
	    svg.insert("path")
	        // specifies only internal state borders should be drawn;
	        // the coastlines are not stroked so as to retain detail around small islands and inlets
	        .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
	        .attr("class", "state-boundary")
	        .attr("d", path);
     					</code></pre>
                    </section>
                    <section data-background="red">
                            <h3> Drawing us.objects.states </h3>
                            <img src="./Part1.PNG">
                	</section>
                	<section data-background="red">
                		Add the CSS file and edit the different attributes of the map!
                	</section>
                </section>
                <section>
                    <h3>Exercise 1:</h3>
                    We have added a lab.css file that you can edit to answer some of these questions.
                    <p>
                    <ol>
			<li>The map is faint and hard to see. What happens if you change the color of the .state-boundaries border? What about the land border?</li>
	                <li>The land in this map has no fill. Change the color of the states.</li>
		        <li>Change the width of the borders.</li>
			<li>Adjust the zoom of the map.</li>
			<li>Have the map show counties instead of only states.</li>
		    </ol>
		    </p>
                </section>
                <section>
                    <section data-background = 'orange'>
                            <h3>PART 2: Utilizing data in D3 Geographic</h3>
                            (...from your favorite dataset)
                        </section>
                        <section data-background = 'orange'>
                                <h3> Drawing the actual map </h3>
                                <h4> Same as before, except ... </h4>
                                <pre><code class="hljs" data-trim contenteditable>
            var w = 1280,
                h = 800,
            opacityCircle = 0.7; // sets the opacity of the circles

            // Projection setup
            var projection = d3.geo.albers()
                .scale(900) // zoom on the map, see alaska and hawaii at 400
                .translate([w / 2 - 200, h / 2 - 100]); // sets location of the map on the screen

            // d3.geo.path is the primary mechanism for displaying geographic data
            // generates the path string suitable for the "d" attribute of an SVG path element
            var path = d3.geo.path()
                // takes the [longitude,latitude] pairs and converts to pixel position [x,y] on screen
                .projection(projection);

            // Add an svg to the body of the page
            var svg = d3.select("body").append("svg")
                .attr("width", w)
                .attr("height", h);
             
            // Draw the map
            // step through the topojoson
            d3.json("../us.json", function(error, us) {
                if (error) throw error; // seems to be a convention in d3 examples to include this, does nothing

                // insert all land masses and classify as land for css to work on
                svg.insert("path", "#states")
                    .datum(topojson.feature(us, us.objects.land))
                    .attr("class", "land")
                    .attr("d", path);
                
                // drawing the state boundaries
                svg.insert("path", "#states")
                    // specifies only internal state borders should be drawn;
                    // the coastlines are not stroked so as to retain detail around small islands and inlets
                    .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
                    .attr("class", "state-boundary")
                    .attr("d", path);
            });
                                    </code></pre>
                        </section>
                        <section data-background="orange">
                                <h3> What's the deal with svg.insert("path", "#states") </h3>
                                <h4>Although this code is written after the d3.json() it is actually ran before</h4>
                                <pre><code class="hljs" data-trim contenteditable>
                                        // Adding states, circles and cells object to a group element ("g") of the SVG
                                        var states = svg.append("g")
                                            .attr("id", "states");
                            
                                        var circles = svg.append("g")
                                            .attr("id", "circles");
                            
                                        var cells = svg.append("g") // will be used for Voronoi diagram
                                            .attr("id", "cells");
                                </code></pre>
                        </section>
                        <section data-background="orange">
                                <h3> What's the deal with svg.insert("path", "#states") </h3>
                                <h4>Passing "#states" to svg.insert inserts this path before the states graph in the html</h4>
                                <img src="./Debugger1.PNG">
                        </section>
                        <section data-background="orange">
                                <h3> Adding our Data </h3>
                                <h4>"g" is for group</h4>
                                <pre><code class="hljs" data-trim contenteditable>
                                        // Adding states, circles and cells object to a group element ("g") of the SVG
                                        var states = svg.append("g")
                                            .attr("id", "states");
                            
                                        var circles = svg.append("g")
                                            .attr("id", "circles");
                            
                                        var cells = svg.append("g") // will be used for Voronoi diagram
                                            .attr("id", "cells");
                                </code></pre>
                        </section>
                        <section data-background="orange">
                                <h3> Adding our Data </h3>
                                <h4>"g" is for group</h4>
                                <img src="./debugger1.png">
                        </section>
                        <section data-background="orange">
                                <h3> Adding our Data</h3>
                                <h4>Instantiating some variables</h4>
                                <pre><code class="hljs" data-trim contenteditable>
                                        // Load in flights data
                                        d3.csv("../data/flights-airport_all.csv", function(flights) {
                                        
                                            var linksByOrigin = {}, // airport connections for drawing lines
                                                countByAirport = {}, // how many airport connections * 5 for calculating circle radius
                                                locationByAirport = {}, // longitude and latitude of airports
                                                Airport_count = {}, // how many flights out of an airport
                                                positions = []; // airport pixel x and y locations
                                            
                                            // this will be used to create the lines between origin and destination airports
                                            var arc = d3.geo.greatArc()
                                                .source(function(d) { return locationByAirport[d.source]; })
                                                .target(function(d) { return locationByAirport[d.target]; });                        
                                </code></pre>
                        </section>
                        <section data-background="orange">
                                <h3> Adding our Data</h3>
                                <h4>Load in some D.C. flights data</h4>
                                <pre><code class="hljs" data-trim contenteditable>
                                    // Load in flights data
                                    d3.csv("../data/flights-airport_all.csv", function(flights) {

                                        ...
                                        
                                        // assigning flight data to variables
                                        flights.forEach(function(flight) { // loop through every row of the csv
                                            var origin = flight.origin, // grab the origin
                                                destination = flight.destination, // grab the destination
                                                count_airport = +flight.count, // the plus converts .count to an integer

                                                // grab the links array associated with this origin, if none initialize empty array
                                                links = linksByOrigin[origin] || (linksByOrigin[origin] = []); 
                                                // add the current origin/destination link to the links array
                                                links.push({source: origin, target: destination});

                                            // counting 5*number of links for each airport location to determine circle size
                                            countByAirport[origin] = (countByAirport[origin] || 0) + 5;
                                            countByAirport[destination] = (countByAirport[destination] || 0) + 5;

                                            // getting counts for flights
                                            Airport_count[origin] = (Airport_count[origin]|| 0)  + count_airport; 
                                        });                                  
                                </code></pre>
                        </section>
                        <section data-background="orange">
                                <h3> Adding our Data</h3>
                                <h4> This data did not have lng, lat of the airports. Use another csv</h4>
                                <pre><code class="hljs" data-trim contenteditable>
                                        // Load in flights data
                                        d3.csv("../data/flights-airport_all.csv", function(flights) {
                                        
                                            ...
                                                
                                            // Load airport location data
                                            d3.csv("../data/airports_2.csv", function(airports) {
                            
                                                airports = airports.filter(function(airport) {
                                                    if (countByAirport[airport.iata]) { // Only consider airports with at least one flight.
                                                        var location = [+airport.longitude, +airport.latitude]; // grab the airport longitude and latitude as integers
                                                        locationByAirport[airport.iata] = location; // store location of airport as key:value in object
                                                        positions.push(projection(location)); // convert latitude and longitude to pixel x and y locations and save to array
                                                        return true; // need to return true to the filter function to keep the airport
                                                    }
                                                });                                   
                                </code></pre>
                        </section>
                        <section data-background="orange">
                                <h3> Adding our Data</h3>
                                <h4> Adding a Voronoi layout </h4>
                                <img src="./Voronoi.PNG">
                        </section>
                        <section data-background="orange">
                                <h3> Adding our Data</h3>
                                <h4> Adding a Voronoi layout </h4>
                                <pre><code class="hljs" data-trim contenteditable>
                                        // Load in flights data
                                        d3.csv("../data/flights-airport_all.csv", function(flights) {
                                        
                                            ...
                                                
                                            // Load airport location data
                                            d3.csv("../data/airports_2.csv", function(airports) {
                            
                                                ...
                                    
                                                // Compute the Voronoi diagram of airports' projected positions.
                                                var polygons = d3.geom.voronoi(positions);    
                                                
                                                // add all the airports to the cells
                                                var g = cells.selectAll("g")
                                                    .data(airports)
                                                    .enter()
                                                    .append("g");  
                                </code></pre>
                        </section>
                        <section data-background="orange">
                                <h3> Adding our Data</h3>
                                <h4> Adding a Voronoi layout </h4>
                                <img src="./cells_g.PNG">
                        </section>
                        <section data-background="orange">
                                <h3> Adding our Data</h3>
                                <h4> Adding a Voronoi layout </h4>
                                <pre><code class="hljs" data-trim contenteditable>
                                        // Load in flights data
                                        d3.csv("../data/flights-airport_all.csv", function(flights) {
                                        
                                            ...
                                                
                                            // Load airport location data
                                            d3.csv("../data/airports_2.csv", function(airports) {
                            
                                                ...                          
                                                                    
                                                // Update "legend" with airport info on mouseover
                                                g.append("path")
                                                    .attr("class", "cell")
                                                    .attr("d", function(d, i) { return "M" + polygons[i].join("L") + "Z"; })                                                           
                                </code></pre>
                        </section>
                        <section data-background="orange">
                                <h3> Adding our Data</h3>
                                <h4> Adding a Voronoi layout </h4>
                                <img src="./cells_d.PNG">
                        </section>
                        <section data-background="orange">
                                <h3> Adding our Data</h3>
                                <h4> Adding a Voronoi layout </h4>
                                <h5> Adding mouseover functionality </h5>
                                <pre><code class="hljs" data-trim contenteditable>
                                        // Load in flights data
                                        d3.csv("../data/flights-airport_all.csv", function(flights) {
                                        
                                            ...
                                                
                                            // Load airport location data
                                            d3.csv("../data/airports_2.csv", function(airports) {
                            
                                                ...                          
                                                                    
                                                // Update "legend" with airport info on mouseover
                                                g.append("path")
                                                    .attr("class", "cell")
                                                    .attr("d", function(d, i) { return "M" + polygons[i].join("L") + "Z"; })
                                                    .on("mouseover", function(d, i) { 
                                                        d3.select("h2 span").text("")
                                                            .append("p").text(d.name).style("font-size", "18px")
                                                            .append("p").text(d.city + ", " + d.state)
                                                            .append("p").text("Flights: " + Airport_count[d.iata]);
                                                    });                                                              
                                </code></pre>
                        </section>
                        <section data-background="orange">
                                <h3> Adding our Data</h3>
                                <h4> Adding a Voronoi layout </h4>
                                <h5> Paragraphs not appended to h2 span until a mouseover event </h5>
                                <img src="./mouseover.PNG">
                        </section>
                        <section data-background="orange">
                                <h3> Adding our Data</h3>
                                <h4> Adding a Voronoi layout </h4>
                                <h5> Paragraphs not appended to h2 span until a mouseover event </h5>
                                <img src="./withmouseover.PNG">
                        </section>
                        <section data-background="orange">
                                <h3> Adding our Data</h3>
                                <h4> Adding connections between airports </h4>
                                <pre><code class="hljs" data-trim contenteditable>
                                        // Load in flights data
                                        d3.csv("../data/flights-airport_all.csv", function(flights) {
                                        
                                            ...
                                                
                                            // Load airport location data
                                            d3.csv("../data/airports_2.csv", function(airports) {
                            
                                                ...                                                                                       
                            
                                                // Create arcs for all links originating out of selected airports
                                                g.selectAll("path.arc")
                                                    .data(function(d) { return linksByOrigin[d.iata] || []; })
                                                    .enter()
                                                    .append("path")
                                                    .attr("class", "arc")
                                                    .attr("d", function(d) { return path(arc(d)); });                                    
                                </code></pre>
                        </section>
                        <section data-background="orange">
                                <h3> Adding our Data</h3>
                                <h4> Adding connections between airports </h4>
                                <img src="./allarcs.PNG">
                        </section>
                        <section data-background="orange">
                                <h3> Adding our Data</h3>
                                <h4> Hiding connections until mouseover </h4>
                                <pre><code class="hljs" data-trim contenteditable>
                                        path.arc {
                                            pointer-events: none;
                                            fill: none;
                                            stroke: #000;
                                            display: none;
                                          }
                                          
                                        path.cell {
                                        fill: none;
                                        pointer-events: all;
                                        }
                                          
                                        #cells g:hover path.arc {
                                        display: inherit;
                                        }                                    
                                </code></pre>
                        </section>
                        <section data-background="orange">
                                <h3> Adding our Data</h3>
                                <pre><code class="hljs" data-trim contenteditable>
                                        // Load in flights data
                                        d3.csv("../data/flights-airport_all.csv", function(flights) {
                                        
                                            ...
                                                
                                            // Load airport location data
                                            d3.csv("../data/airports_2.csv", function(airports) {
                            
                                                ...                                                                                                                  
                            
                                                // Create circles
                                                circles.selectAll("circle")
                                                    .data(airports)
                                                    .enter()
                                                    .append("circle")
                                                    .attr("cx", function(d, i) { return positions[i][0]; })
                                                    .attr("cy", function(d, i) { return positions[i][1]; })
                                                    .attr("r", function(d, i) { return Math.sqrt(countByAirport[d.iata]); })
                                                    .sort(function(a, b) { return countByAirport[b.iata] - countByAirport[a.iata]; })
                                                    .attr("fill", "orange")
                                                    .attr('opacity', opacityCircle);
                                            });
                                        });                                    
                                </code></pre>
                        </section>
                        <section data-background="orange">
                                <h3> Adding our Data</h3>
                                <img src="./circles.PNG">
                        </section>
                        <section data-background="orange">
                                <h3> Adding our Data</h3>
                                <img src="./Final.png">
                        </section>
                </section>
                <section>
                    <h3>Exercise 2:</h3>
                    Last week, we created a .csv with airport origins, destinations, and counts. This file required some cleaning to remove US airports not within the states. We have provided you with the resulting .csv, "filteredflights.csv".
                    <p>
                    <ol>
                        <li>Replace the current data with this csv in the code.</li>
                        <li>The circles are now hard to discern due to the overlap. Adjust the circle features to better show individual airports.</li>
                        <li>Change the radius of the circle to depend upon number of flights (counts) instead of "links".</li>
                        <li>Adjust how the radius is calculated from the counts for better scaled circles.</li>
                    </ol>
                    </p>
                </section>                
            </div>
        </div>

        <script src="lib/js/head.min.js"></script>
        <script src="js/reveal.js"></script>

        <script>
            // More info about config & dependencies:
            // - https://github.com/hakimel/reveal.js#configuration
            // - https://github.com/hakimel/reveal.js#dependencies
            Reveal.initialize({
                dependencies: [
                    { src: 'plugin/markdown/marked.js' },
                    { src: 'plugin/markdown/markdown.js' },
                    { src: 'plugin/notes/notes.js', async: true },
                    { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
                ]
            });
        </script>
    </body>
</html>
